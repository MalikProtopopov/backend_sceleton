# =============================================================================
# Development Docker Compose Configuration
# =============================================================================
# Usage:
#   make dev-up      # Start all services
#   make dev-down    # Stop all services
#   make dev-logs    # View logs
#
# Or directly:
#   docker compose up -d
#   docker compose down
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL Database
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:16-alpine
    container_name: cms_postgres_dev
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: cms
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - cms_network

  # ---------------------------------------------------------------------------
  # Redis for caching and task queue
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: cms_redis_dev
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - cms_network

  # ---------------------------------------------------------------------------
  # MinIO (S3-compatible storage for local development)
  # ---------------------------------------------------------------------------
  minio:
    image: minio/minio:latest
    container_name: cms_minio_dev
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"   # S3 API
      - "9001:9001"   # Web Console
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - cms_network

  # ---------------------------------------------------------------------------
  # MinIO Setup (creates bucket on first run)
  # ---------------------------------------------------------------------------
  minio-setup:
    image: minio/mc:latest
    container_name: cms_minio_setup
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 minioadmin minioadmin;
      mc mb myminio/cms-assets --ignore-existing;
      mc anonymous set public myminio/cms-assets;
      echo 'MinIO bucket setup complete';
      exit 0;
      "
    networks:
      - cms_network

  # ---------------------------------------------------------------------------
  # FastAPI Backend Application
  # ---------------------------------------------------------------------------
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cms_backend_dev
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # Override for Docker network
      DATABASE_URL: postgresql+asyncpg://postgres:postgres@postgres:5432/cms
      REDIS_URL: redis://redis:6379/0
      S3_ENDPOINT_URL: http://minio:9000
      ENVIRONMENT: development
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    volumes:
      # Mount app code for hot-reload in development
      - ./app:/app/app:ro
      - ./alembic:/app/alembic:ro
    networks:
      - cms_network

  # ---------------------------------------------------------------------------
  # Database migrations (run once on startup)
  # ---------------------------------------------------------------------------
  migrations:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cms_migrations_dev
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:postgres@postgres:5432/cms
    command: alembic upgrade head
    depends_on:
      postgres:
        condition: service_healthy
    restart: "no"
    networks:
      - cms_network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres_data:
    name: cms_postgres_data_dev
  redis_data:
    name: cms_redis_data_dev
  minio_data:
    name: cms_minio_data_dev

# =============================================================================
# Networks
# =============================================================================
networks:
  cms_network:
    name: cms_network_dev
    driver: bridge
